## トランザクションについて

#### トランザクションとは
データベースどなどを操作する場合に、**一つの作業単位**(一連の捜査の集まり)をトランザクションといいます。トランザクションは完全成功か変更内容破棄するかを保証しています。

#### ACID属性

- 原子性(Atomicity)
 
    トランザクションは上でも書いた通り、完全成功か変更内容破棄しかありえません。中途半端な状態は存在してはいけないのです。

 - 一貫性(Consistency)

    トランザクションの実行前と実行後でデータの整合性が保たれることです。
    なので、パラメーターが同じならば、そのトランザクションの結果は必ず同じ結果にならないといけないのです。

- 分離性(Isolation)

    トランザクションが実行中にほかのトランザクションに影響を与えない性質です。

- 永続性(Durability)

    トランザクションが終了後、その処理が行った結果のデータは永続的に残ります。たとえシステム障害が発生してもデータが失われることがない性質です。

#### トランザクション分離レベルとは

- Dirty Read

    トランザクションBでトランザクションAのコミットされていないデータを読み取れること。

- Fuzzy Read

    トランザクションAでテーブルの中身を更新した内容をコミットしたときに、トランザクションBでそのコミットの内容を読み取れてしまうこと。

- Phantom Read

    トランザクションAでテーブルの中身を追加、削除した内容をコミットしたときに、トランザクションBでそのコミットの内容を読み取れてしまうこと。

#### 分離レベルの段階

ANSI/ISO SQL標準で定められている分離レベルは、下記の4種類です。

- READ UNCOMMITTED(___確定していないデータまで読み取る___)

    他のトランザクションによって変更途中のデータを読み取れる。

- READ COMMITTED(___確定した最新データを常に読み取る___)

    他のトランザクションによって更新されたデータを読み取れる。

- REPEATABLE READ(___読み取り対象のデータを常に読み取る___)

    他のトランザクションによって追加、削除されたデータを読み取れる。

- SERIALIZABLE(___直列化可能___)

    最も強い分離レベルであり、最も安全にデータを操作できる。
    複数トランザクションが入り混じらないように、強制的にトランザクションを順序付けて実行する。


|分離レベル|Dirty Read|Fuzzy Read|Phantom Read|
|---|:-:|:-:|:-:|
|READ UNCOMMITTED|〇|〇|〇|    
|READ COMMITTED|×|〇|〇|
|REPEATABLE READ|×|×|〇|
|SERIALIZABLE|×|×|×|

〇: 発生する　×:発生しない

#### 対処方法

- トランザクションが終了するまで他のトランザクションを実行しない。

    データの整合性は取れるが、Userが処理待ちになるのであまりお勧めできない。

- 最初にデータを読み取り、そのデータをもとに変更をかける。    

- 読み取ったレコードにロックをかけて、他のトランザクションがそのレコードにアクセスできないようにする。

